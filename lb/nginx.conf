events {}

http {
  log_format main '$remote_addr - $remote_user [$time_local] '
                  '"$request" $status $body_bytes_sent '
                  '"$http_referer" "$http_user_agent" '
                  'rt=$request_time uct=$upstream_connect_time '
                  'uht=$upstream_header_time urt=$upstream_response_time '
                  'ua="$upstream_addr"';
  access_log /dev/stdout main;
  error_log /dev/stderr warn;

  # Docker embedded DNS
  resolver 127.0.0.11 valid=10s ipv6=off;

  server {
    listen 80;

    location / {
      # Use a variable so nginx re-resolves DNS periodically
      set $upstream exchange;
      proxy_pass http://$upstream:8080;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header Connection "";
    }
  }
}
