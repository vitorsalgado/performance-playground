# Project name; DSP replica hostnames match Compose v2 container names: adtech-dsp-1, adtech-dsp-2, ...
name: adtech

services:
  # Exchange
  # This is the main service that will be used for performance testing.
  # --

  exchange:
    build:
      context: ./
      args:
        - APP=exchange
    expose:
      - '8080'
    environment:
      - EXCHANGE_APPS_CACHE_PATH=/apps.json
      - EXCHANGE_DSPS_CACHE_PATH=/dsps.json
      - EXCHANGE_INTERN_STRINGS=false
    deploy:
      mode: replicated
      replicas: 1
    depends_on:
      - vector
      - victoriametrics
      - victorialogs
      - vmalert
      - grafana
      - alertmanager
      - pyroscope
      - dsp
    volumes:
      - ./d/apps.json:/apps.json:ro
      - ./d/dsps.json:/dsps.json:ro
    labels:
      application: exchange
      group: exchange

  # Load Balancer
  # The load balancer is the entrypoint for the exchange applications.
  # --

  lb:
    image: nginx:alpine
    container_name: lb
    hostname: lb
    depends_on:
      - exchange
      - vector
      - victoriametrics
      - victorialogs
      - vmalert
      - grafana
      - alertmanager
    ports:
      - '9999:80'
    volumes:
      - ./lb/nginx.conf:/etc/nginx/nginx.conf:ro
    labels:
      application: lb
      group: exchange

  # DSPs
  # Replica count from .env DSP_COUNT (run `make gen-dsp-config` after changing).
  # Each replica is reachable by hostname adtech-dsp-1, adtech-dsp-2, ... (Compose v2 container names).
  # --

  dsp:
    build:
      context: ./
      args:
        - APP=dsp
    deploy:
      mode: replicated
      replicas: ${DSP_COUNT:-25}
    expose:
      - '8080'
    depends_on:
      - vector
      - victoriametrics
      - victorialogs
      - vmalert
      - grafana
      - alertmanager
      - pyroscope
    labels:
      application: dsp
      group: exchange

  # Observability (o11y)
  # The observability is based on the VictoriaMetrics stack.
  # --

  victoriametrics:
    image: victoriametrics/victoria-metrics:latest
    container_name: victoriametrics
    hostname: victoriametrics
    ports:
      - '8428:8428'
    volumes:
      - victoriametrics-data:/victoria-metrics-data
    command:
      - '-storageDataPath=/victoria-metrics-data'
      - '-retentionPeriod=30d'
    labels:
      application: victoriametrics
      group: o11y

  vmagent:
    image: victoriametrics/vmagent:latest
    container_name: vmagent
    hostname: vmagent
    depends_on:
      - victoriametrics
      - exchange
      - cadvisor
    ports:
      - '8429:8429'
    volumes:
      - ./o11y/vmagent/scrape.yml:/etc/vmagent/scrape.yml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command:
      - '-promscrape.config=/etc/vmagent/scrape.yml'
      - '-remoteWrite.url=http://victoriametrics:8428/api/v1/write'
      - '-httpListenAddr=:8429'
      # Align Docker service discovery with scrape interval to reduce metric gaps
      - '-promscrape.dockerSDCheckInterval=5s'
    labels:
      application: vmagent
      group: o11y

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    hostname: cadvisor
    privileged: true
    ports:
      - '8086:8080'
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:rw
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    # Export Docker Compose labels so Grafana can filter exchange by container_label_com_docker_compose_service
    command:
      - -store_container_labels=false
      - -whitelisted_container_labels=com.docker.compose.service,com.docker.compose.project
    labels:
      application: cadvisor
      group: o11y

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    hostname: grafana
    depends_on:
      - victoriametrics
    ports:
      - '3000:3000'
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_DISABLE_LOGIN_FORM=true
      - GF_LOG_LEVEL=error
      - GF_PLUGINS_PREINSTALL_SYNC=grafana-pyroscope-app
    volumes:
      - grafana-data:/var/lib/grafana
      - ./o11y/grafana/grafana.ini:/etc/grafana/grafana.ini:ro
      - ./o11y/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./o11y/grafana/dashboards:/var/lib/grafana/dashboards:ro
    labels:
      application: grafana
      group: o11y

  # Alerting
  # --

  alertmanager:
    image: prom/alertmanager:latest
    container_name: alertmanager
    hostname: alertmanager
    ports:
      - '9093:9093'
    volumes:
      - ./o11y/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager-data:/alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    labels:
      application: alertmanager
      group: o11y

  vmalert:
    image: victoriametrics/vmalert:latest
    container_name: vmalert
    hostname: vmalert
    depends_on:
      - victoriametrics
      - alertmanager
    ports:
      - '8880:8880'
    volumes:
      - ./o11y/vmalert/rules:/etc/vmalert/rules:ro
    command:
      - '-datasource.url=http://victoriametrics:8428'
      - '-remoteWrite.url=http://victoriametrics:8428/api/v1/write'
      - '-notifier.url=http://alertmanager:9093'
      - '-rule=/etc/vmalert/rules/*.yml'
      - '-httpListenAddr=:8880'
    labels:
      application: vmalert
      group: o11y

  # Logging
  # --

  victorialogs:
    image: victoriametrics/victoria-logs:latest
    container_name: victorialogs
    hostname: victorialogs
    ports:
      - '9428:9428'
    volumes:
      - victorialogs-data:/victoria-logs-data
    command:
      - '-storageDataPath=/victoria-logs-data'
      - '-httpListenAddr=:9428'
    labels:
      application: victorialogs
      group: o11y

  vector:
    image: timberio/vector:latest-alpine
    container_name: vector
    hostname: vector
    depends_on:
      - victorialogs
    volumes:
      - ./o11y/victorialogs/vector.yaml:/etc/vector/vector.yaml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - vector-data:/var/lib/vector
    command:
      - '--config'
      - '/etc/vector/vector.yaml'
    labels:
      application: vector
      group: o11y

  # Continuous Profiling
  # --

  pyroscope:
    image: grafana/pyroscope:latest
    container_name: pyroscope
    hostname: pyroscope
    ports:
      - '4040:4040'
    volumes:
      - pyroscope-data:/data
    command:
      - '-pyroscopedb.data-path=/data'
    labels:
      application: pyroscope
      group: o11y

  alloy:
    image: grafana/alloy:latest
    container_name: alloy
    hostname: alloy
    depends_on:
      - pyroscope
    ports:
      - '12345:12345'
    volumes:
      - ./o11y/pyroscope/config.alloy:/etc/alloy/config.alloy:ro
      - alloy-data:/var/lib/alloy/data
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command:
      - 'run'
      - '--disable-reporting=true'
      - '--stability.level=experimental'
      - '--storage.path=/var/lib/alloy/data'
      - '--server.http.listen-addr=0.0.0.0:12345'
      - '/etc/alloy/config.alloy'
    labels:
      application: alloy
      group: o11y

volumes:
  victoriametrics-data:
  grafana-data:
  alertmanager-data:
  victorialogs-data:
  vector-data:
  pyroscope-data:
  alloy-data:
