version: '3.9'

services:
  # Exchange
  # This is the main service that will be used for performance testing.
  # --

  exchange:
    build:
      context: ./
    expose:
      - '8080'
    deploy:
      mode: replicated
      replicas: 5
    depends_on:
      - vector
      - victoriametrics
      - victorialogs
      - vmalert
      - grafana
      - alertmanager
      - pyroscope
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8080/ping']
      interval: 30s
      timeout: 10s
      retries: 5
    labels:
      application: exchange
      group: exchange

  # Load Balancer
  # The load balancer is the entrypoint for the exchange applications.
  # --

  lb:
    image: nginx:alpine
    container_name: lb
    hostname: lb
    depends_on:
      - exchange
      - vector
      - victoriametrics
      - victorialogs
      - vmalert
      - grafana
      - alertmanager
    ports:
      - '8080:80'
    volumes:
      - ./lb/nginx.conf:/etc/nginx/nginx.conf:ro
    labels:
      application: lb
      group: exchange

  # Observability (o11y)
  # The observability is based on the VictoriaMetrics stack.
  # --

  victoriametrics:
    image: victoriametrics/victoria-metrics:latest
    container_name: victoriametrics
    hostname: victoriametrics
    ports:
      - '8428:8428'
    volumes:
      - victoriametrics-data:/victoria-metrics-data
    command:
      - '-storageDataPath=/victoria-metrics-data'
      - '-retentionPeriod=30d'
    labels:
      application: victoriametrics
      group: o11y

  vmagent:
    image: victoriametrics/vmagent:latest
    container_name: vmagent
    hostname: vmagent
    depends_on:
      - victoriametrics
      - exchange
    ports:
      - '8429:8429'
    volumes:
      - ./o11y/vmagent/scrape.yml:/etc/vmagent/scrape.yml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command:
      - '-promscrape.config=/etc/vmagent/scrape.yml'
      - '-remoteWrite.url=http://victoriametrics:8428/api/v1/write'
      - '-httpListenAddr=:8429'
    labels:
      application: vmagent
      group: o11y

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    hostname: grafana
    depends_on:
      - victoriametrics
    ports:
      - '3000:3000'
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_LOG_LEVEL=error
    volumes:
      - grafana-data:/var/lib/grafana
      - ./o11y/grafana/grafana.ini:/etc/grafana/grafana.ini:ro
      - ./o11y/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./o11y/grafana/dashboards:/var/lib/grafana/dashboards:ro
    labels:
      application: grafana
      group: o11y

  # Alerting
  # --

  alertmanager:
    image: prom/alertmanager:latest
    container_name: alertmanager
    hostname: alertmanager
    ports:
      - '9093:9093'
    volumes:
      - ./o11y/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager-data:/alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    labels:
      application: alertmanager
      group: o11y

  vmalert:
    image: victoriametrics/vmalert:latest
    container_name: vmalert
    hostname: vmalert
    depends_on:
      - victoriametrics
      - alertmanager
    ports:
      - '8880:8880'
    volumes:
      - ./o11y/vmalert/rules:/etc/vmalert/rules:ro
    command:
      - '-datasource.url=http://victoriametrics:8428'
      - '-remoteWrite.url=http://victoriametrics:8428/api/v1/write'
      - '-notifier.url=http://alertmanager:9093'
      - '-rule=/etc/vmalert/rules/*.yml'
      - '-httpListenAddr=:8880'
    labels:
      application: vmalert
      group: o11y

  # Logging
  # --

  victorialogs:
    image: victoriametrics/victoria-logs:latest
    container_name: victorialogs
    hostname: victorialogs
    ports:
      - '9428:9428'
    volumes:
      - victorialogs-data:/victoria-logs-data
    command:
      - '-storageDataPath=/victoria-logs-data'
      - '-httpListenAddr=:9428'
    labels:
      application: victorialogs
      group: o11y

  vector:
    image: timberio/vector:latest-alpine
    container_name: vector
    hostname: vector
    depends_on:
      - victorialogs
    volumes:
      - ./o11y/victorialogs/vector.yaml:/etc/vector/vector.yaml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - vector-data:/var/lib/vector
    command:
      - '--config'
      - '/etc/vector/vector.yaml'
    labels:
      application: vector
      group: o11y

  # Continuous Profiling
  # --

  pyroscope:
    image: grafana/pyroscope:latest
    container_name: pyroscope
    hostname: pyroscope
    ports:
      - '4040:4040'
    volumes:
      - pyroscope-data:/data
    command:
      - '-pyroscopedb.data-path=/data'
    labels:
      application: pyroscope
      group: o11y

  alloy:
    image: grafana/alloy:latest
    container_name: alloy
    hostname: alloy
    depends_on:
      - pyroscope
    ports:
      - '12345:12345'
    volumes:
      - ./o11y/pyroscope/alloy.alloy:/etc/alloy/config.alloy:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command:
      - 'run'
      - '--server.http.listen-addr=0.0.0.0:12345'
      - '/etc/alloy/config.alloy'
    labels:
      application: alloy
      group: o11y

volumes:
  victoriametrics-data:
  grafana-data:
  alertmanager-data:
  victorialogs-data:
  vector-data:
  pyroscope-data:
